#!/bin/bash

echo "üöÄ –î–µ–ø–ª–æ–π –≤ –≤–µ—Ç–∫—É deploy..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ docs
if [ ! -d "docs" ]; then
  echo "‚ùå –ü–∞–ø–∫–∞ docs –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
  exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º URL —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
REMOTE_URL=$(git remote get-url origin)
if [ -z "$REMOTE_URL" ]; then
  echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π origin"
  exit 1
fi

echo "üîó –£–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: $REMOTE_URL"

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
TEMP_DIR="/tmp/deploy-$(date +%s)"
mkdir -p "$TEMP_DIR"

# –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
echo "üì• –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
git clone "$REMOTE_URL" "$TEMP_DIR"
cd "$TEMP_DIR"

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–µ—Ç–∫—É deploy –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –µ—ë
echo "üåø –†–∞–±–æ—Ç–∞–µ–º —Å –≤–µ—Ç–∫–æ–π deploy..."
if git show-ref --verify --quiet refs/heads/deploy; then
  git checkout deploy
else
  git checkout -b deploy
fi

# –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–µ—Ç–∫–∏ deploy
echo "üßπ –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–µ—Ç–∫–∏ deploy..."
git rm -rf . >/dev/null 2>&1 || true

# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ docs –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
echo "üìÅ –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ..."
cp -r "$OLDPWD/docs"/* .

# –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –∏ –∫–æ–º–º–∏—Ç–∏–º
echo "üíæ –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç..."
git add .
git commit -m "Deploy build $(date)" || echo "‚ÑπÔ∏è  –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"

# –ü—É—à–∏–º –≤ –≤–µ—Ç–∫—É deploy
echo "üì§ –ü—É—à–∏–º –≤ –≤–µ—Ç–∫—É deploy..."
git push origin deploy

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∏ –æ—á–∏—â–∞–µ–º
echo "üßπ –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É..."
cd "$OLDPWD"
rm -rf "$TEMP_DIR"

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
